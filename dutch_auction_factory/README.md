# Dutch Auction Factory Contract

A smart contract factory that deploys Dutch auction instances using Arbitrum Stylus and Rust. This factory uses `RawDeploy` with CREATE2 to deterministically deploy new auction contracts with embedded bytecode.

## Features

- **True Factory Deployment**: Actually deploys new Dutch auction contracts (not just registration)
- **Embedded Bytecode**: Dutch auction WASM bytecode is embedded at compile time
- **CREATE2 Deployment**: Deterministic contract addresses using CREATE2 with parameter-based salt
- **No Constructor Args**: Factory deployment requires no parameters thanks to `include_bytes!`
- **Gas Efficient**: Optimized deployment process with pre-compiled bytecode
- **Event Tracking**: Complete auction creation history via events

## Quick Start

### Prerequisites

- [Rust](https://rustup.rs/) toolchain
- [Cargo Stylus](https://github.com/OffchainLabs/cargo-stylus)
- Compiled Dutch auction WASM bytecode

### Installation

```bash
cargo install cargo-stylus
rustup target add wasm32-unknown-unknown
```

### Build Process

⚠️ **Important**: The Dutch auction must be built first since its bytecode is embedded in the factory.

#### 1. Build Dutch Auction:
```bash
cd ../dutch_auction
cargo stylus check
```

#### 2. Build Factory:
```bash
cd ../dutch_auction_factory
cargo stylus check
```

### Build Commands

#### Check contract validity:
```bash
cargo stylus check
```

#### Build for production:
```bash
cargo build --release
```

#### Export ABI:
```bash
cargo stylus export-abi
```

### Deployment

#### Deploy to Arbitrum Sepolia (testnet):
```bash
cargo stylus deploy \
    --endpoint <yourRPCurl> \
    --private-key <yourPrivateKey>
```


### Constructor Parameters

✅ **No constructor parameters needed!** The factory is initialized with:

```rust
new() -> Result<(), Vec<u8>>
```

The Dutch auction bytecode is embedded at compile time using `include_bytes!`.

### Contract Size & Cost

- **Contract Size**: ~22.4 KiB (includes embedded auction bytecode)
- **Deployment Cost**: ~0.000131 ETH
- **WASM Size**: ~101.2 KiB
- **Embedded Bytecode**: ~67.9 KiB (Dutch auction WASM)

## Usage

### Core Functions

#### Create New Auction
```rust
create_auction(
    nft_contract: Address,
    token_id: U256,
    starting_price: U256,
    ending_price: U256,
    duration: U256
) -> Result<Address, Vec<u8>>
```

Returns the deployed auction contract address.

### View Functions

#### Factory Information
```rust
get_auction(auction_id: U256) -> Address
get_auction_count() -> U256
get_owner() -> Address
get_bytecode_length() -> U256
```

## How It Works

### 1. Bytecode Embedding
```rust
// Embeds compiled WASM at compile time
static DUTCH_AUCTION_WASM: &[u8] = include_bytes!("../dutch_auction.wasm");
```

### 2. CREATE2 Deployment
```rust
// Deterministic salt from parameters
let salt = keccak256(auction_id + sender + nft_contract + token_id);

// Deploy with RawDeploy
let auction_address = RawDeploy::new()
    .salt(salt)
    .deploy(&bytecode, 0)?;
```

### 3. Automatic Registration
- Each deployed auction is automatically registered
- Auction ID is incremented
- Events are emitted for tracking

## Events

- `AuctionCreated(uint256 indexed auction_id, address indexed creator, address indexed nft_contract, uint256 token_id, uint256 starting_price, uint256 ending_price, uint256 duration, address auction_address)`

## Security Features

- **Input Validation**: Comprehensive validation for all auction parameters
- **Deterministic Deployment**: CREATE2 address generation prevents collisions
- **Owner Controls**: Access control for administrative functions
- **Safe Bytecode Handling**: Embedded bytecode is validated at compile time


## Architecture

```
┌─────────────────────┐
│ DutchAuctionFactory │
│                     │
│ ┌─────────────────┐ │
│ │ Embedded WASM   │ │
│ │ Bytecode        │ │
│ │ (~67.9 KiB)     │ │
│ └─────────────────┘ │
│                     │
│ create_auction()    │
│       ↓             │
│ ┌─────────────────┐ │
│ │ RawDeploy       │ │
│ │ + CREATE2       │ │
│ └─────────────────┘ │
└─────────────────────┘
         ↓
┌─────────────────────┐
│ New DutchAuction    │
│ Contract Instance   │
└─────────────────────┘
```

## Build Dependencies

The factory requires the Dutch auction WASM file to exist:
- **Location**: `../dutch_auction/target/wasm32-unknown-unknown/release/dutch_auction.wasm`
- **Generated by**: `cargo stylus check` in dutch_auction directory
- **Embedded at**: Factory compile time

## Development

### Run Tests
```bash
cargo test
```

### Local Development
```bash
cargo stylus check --endpoint http://localhost:8547
```

### Rebuild Process
If the Dutch auction contract changes:

1. Rebuild Dutch auction: `cd ../dutch_auction && cargo stylus check`
2. Rebuild factory: `cargo stylus check`

## Advanced Features

### RawDeploy Implementation
- Uses deprecated but functional `RawDeploy` API
- CREATE2 with deterministic salt generation
- Proper error handling for deployment failures
- Gas-efficient deployment process

### Bytecode Management
- Compile-time embedding eliminates runtime storage costs
- Automatic bytecode size validation
- No external dependencies for deployment

## License

This project is licensed under MIT OR Apache-2.0.